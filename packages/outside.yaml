################################################################
## Packages / Outside
##   Roof Lights, Front Gate, Septic Controller
################################################################

################################################################
## Customize
################################################################
homeassistant:
  customize:
    ################################################
    ## Cover
    ################################################
    cover.front_gate:
      friendly_name: "Front Gate"
      device_class: garage

    ################################################
    ## Switch
    ################################################
    switch.house_flood_lights:
      friendly_name: "House Flood Lights"
      icon: mdi:spotlight-beam
    switch.house_porch_lights:
      friendly_name: "House Porch Lights"
      icon: mdi:lightbulb

##################################################
## input_number
##################################################
input_number:
  roof_lights_transition_time:
    name: "Roof Lights Transition Time"
    min: 1
    max: 300
    step: 1

##################################################
## input_boolean
##################################################
input_boolean:
  christmas_season:
    name: Christmas Lights Auto On
    icon: mdi:pine-tree
  flood_lights:
    name: "Flood Lights"
    icon: mdi:spotlight-beam

################################################################
## Sensor
################################################################
sensor:
  # accumulates the time the effluent pump is on in hours
  # time is offset to better match the pumping schedule
  - platform: history_stats
    name: "Septic Pump Hours Yesterday"
    entity_id: binary_sensor.septic_pump
    state: 'on'
    type: time
    # 3AM yesterday to 3AM this morning.
    end: '{{ now().replace(hour=3).replace(minute=0).replace(second=0) }}'
    duration:
      hours: 24

  - platform: template
    sensors:
      # converts the Septic Hours Yesterday minutes
      septic_minutes_yesterday:
        friendly_name: "Septic Pump Time Yesterday"
        entity_id: sensor.septic_pump_hours_yesterday
        unit_of_measurement: "m"
        value_template: '{{ states.sensor.septic_pump_hours_yesterday.state | multiply(60.0) | round(2) }}'

      # Given that it takes 27 minutes to pump out a full tank this sensor
      # provides an idea of septic usage in percent of maximum pump time
      septic_usage_yesterday:
        friendly_name: "Septic Usage Yesterday"
        entity_id: sensor.septic_pump_hours_yesterday
        unit_of_measurement: "%"
        # multiply by 60 * 100.0 / 27.0
        value_template: '{{ states.sensor.septic_pump_hours_yesterday.state | multiply(222.222222222) | round(0) }}'

################################################################
## Binary Sensor
################################################################
binary_sensor:
  - platform: template
    sensors:
      # Turns on when Front Gate has been open too long
      front_gate_open_too_long:
        friendly_name: "Front Gate open too long"
        delay_on: '00:04:00'
        value_template: "{{ is_state('cover.front_gate', 'open') }}"

      # Turns on when Front Gate Controller has been off the network for too long
      front_gate_controller_not_on_network:
        friendly_name: "Front Gate controller not on network"
        delay_on: '03:00:00'
        value_template: "{{ is_state('device_tracker.front_gate_controller', 'away') }}"

      # Turns on when Septic Controller has been off the network for too long
      septic_controller_not_on_network:
        friendly_name: "Septic controller not on network"
        delay_on: '03:00:00'
        value_template: "{{ is_state('device_tracker.septic_controller', 'away') }}"

      # Turns on when Septic Controller has not been Idle for too long
      septic_controller_not_idle:
        friendly_name: "Septic controller not Idle for too long"
        delay_on: '01:00:00'
        value_template: "{{ not is_state('sensor.septic_status', 'Idle') }}"

################################################################
## Automation
################################################################
automation:
  # Front Gate Opened Say in House
  - id: front_gate_opened
    alias: Front Gate Opened
    trigger:
      platform: state
      entity_id: cover.front_gate
      to: 'open'
    action:
      - service: script.sonos_house_all_say
        data:
          volume: 0.5
          delay: '00:00:02'
          message: 'Front Gate Open.'

  # Front Gate Opened Say in Studio
  - id: front_gate_opened
    alias: Front Gate Opened
    trigger:
      platform: state
      entity_id: cover.front_gate
      to: 'open'
    condition:
      # if guest mode is enabled don't say anything when guests might be sleeping
      condition: or
      conditions:
        # guest mode disabled
        - condition: state
          entity_id: input_boolean.guest_mode
          state: 'off'
        # after 10PM
        - condition: time
          after: '21:00:00'
        # before 9AM
        - condition: time
          before: '9:00:00'
    action:
      - service: script.sonos_studio_all_say
        data:
          volume: 0.5
          delay: '00:00:02'
          message: 'Front Gate Open.'

  # Front Gate Open too long
  - alias: Front Gate Open too Long
    trigger:
      platform: state
      entity_id: binary_sensor.front_gate_open_too_long
      to: 'on'
    action:
      - service: script.sonos_all_say
        data:
          volume: 0.8
          delay: '00:00:03'
          message: 'Front Gate Open Too Long.'

  # Turn Flood Lights on/off
  - id: sync_flood_lights
    alias: "Share Flood Lights between House and Studio"
    trigger:
      platform: state
      entity_id: input_boolean.flood_lights
    action:
      - service_template: 'homeassistant.turn_{{trigger.to_state.state}}'
        entity_id: switch.house_flood_lights
      - service_template: 'homeassistant.turn_{{trigger.to_state.state}}'
        entity_id: switch.studio_flood_lights

  # Handle Roof Lights transition time
  - id: roof_lights_transition_time
    alias: "Roof Lights Transition Time Send MQTT"
    trigger:
      platform: state
      entity_id: input_number.roof_lights_transition_time
    action:
      # - service: light.turn_on
      #   data_template:
      #     entity_id: "light.roof_lights"
      #     transition: "{{ trigger.to_state.state }}"
      - service: mqtt.publish
        data_template:
          topic: "hass/light/roof_lights/rgblight/set"
          payload: '{"transition": {{ trigger.to_state.state | int }}}'

  # Roof lights are turned on at just the right time after sunset
  - id: roof_lights_auto_on
    alias: "Roof Lights Automatic On"
    trigger:
      platform: numeric_state
      entity_id: sun.sun
      value_template: "{{ state.attributes.elevation }}"
      below: -5.0
    action:
      - service: homeassistant.turn_on
        entity_id: light.roof_lights

  # Roof lights go off at 2:00AM
  - id: roof_lights_auto_off
    alias: "Roof Lights Automatic Off"
    trigger:
      platform: time
      at: "02:00:00"
    action:
      - service: homeassistant.turn_off
        entity_id: light.roof_lights

  # Christmas lights are turned on at just the right time after sunset
  - id: christmas_lights_auto_on
    alias: "Christmas Lights Automatic On"
    trigger:
      platform: numeric_state
      entity_id: sun.sun
      value_template: "{{ state.attributes.elevation }}"
      below: -5.0
    condition:
      condition: state
      entity_id: input_boolean.christmas_season
      state: 'on'
    action:
      - service: homeassistant.turn_on
        entity_id: switch.house_christmas_lights
      - service: homeassistant.turn_on
        entity_id: switch.studio_christmas_lights

  # Christmas lights go off at 2:00AM
  - id: christmas_lights_auto_off
    alias: "Christmas Lights Automatic Off"
    trigger:
      platform: time
      at: "02:00:00"
    action:
      - service: homeassistant.turn_off
        entity_id: switch.house_christmas_lights
      - service: homeassistant.turn_off
        entity_id: switch.studio_christmas_lights

  # Turn on house back porch light when studio porch light is turned on
  - alias: "House Back Porch Light On"
    trigger:
      # Studio Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.studio_porch_light
          control: 'DON'
      - platform: state
        entity_id: switch.studio_porch_light
        to: 'on'
    action:
      - service: homeassistant.turn_on
        entity_id: switch.back_porch_light

  # Turn on house porch lights when studio porch light is turned fast on
  - alias: "House Porch Lights Fast On"
    trigger:
      # Studio Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.studio_porch_light
          control: 'DFON'
    action:
      - service: homeassistant.turn_on
        entity_id: switch.house_porch_lights

  # Turn off house back porch light when studio porch light is turned off
  - alias: "House Back Porch Light Off"
    trigger:
      # Studio Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.studio_porch_light
          control: 'DOF'
      - platform: state
        entity_id: switch.studio_porch_light
        to: 'off'
    action:
      - service: homeassistant.turn_off
        entity_id: switch.back_porch_light

  # Turn off house porch lights when studio porch light is turned fast off
  - alias: "House Porch Lights Fast Off"
    trigger:
      # Studio Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.studio_porch_light
          control: 'DFOF'
    action:
      - service: homeassistant.turn_off
        entity_id: switch.house_porch_lights

  # Turn on studio porch light when house back porch light is turned on
  - alias: "Studio Porch Light On"
    trigger:
      # Master Bedroom Back Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.back_porch_light_1
          control: 'DON'
      # Utility Room Back Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.back_porch_light_2
          control: 'DON'
      # Garage Back Porch Button
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.back_porch_light_3
          control: 'DON'
    action:
      - service: homeassistant.turn_on
        entity_id: switch.studio_porch_lights

  # Turn on studio porch light when house porch lights are turned fast on
  - alias: "Studio Porch Light Fast On"
    trigger:
      # Family Room Front Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.front_porch_light
          control: 'DFON'
      # Master Bedroom Back Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.back_porch_light_1
          control: 'DFON'
      # Utility Room Back Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.back_porch_light_2
          control: 'DFON'
      # Garage Back Porch Button
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.back_porch_light_3
          control: 'DFON'
    action:
      - service: homeassistant.turn_on
        entity_id: switch.studio_porch_lights

  # Turn off studio porch light when house back porch light is turned off
  - alias: "Studio Porch Light Off"
    trigger:
      # Master Bedroom Back Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.back_porch_light_1
          control: 'DOF'
      # Utility Room Back Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.back_porch_light_2
          control: 'DOF'
      # Garage Back Porch Button
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.back_porch_light_3
          control: 'DOF'
    action:
      - service: homeassistant.turn_off
        entity_id: switch.studio_porch_lights

  # Turn off studio porch light when house porch lights are turned fast off
  - alias: "Studio Porch Light Fast Off"
    trigger:
      # Family Room Front Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.front_porch_light
          control: 'DFOF'
      # Master Bedroom Back Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.back_porch_light_1
          control: 'DFOF'
      # Utility Room Back Porch Switch
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.back_porch_light_2
          control: 'DFOF'
      # Garage Back Porch Button
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.back_porch_light_3
          control: 'DFOF'
    action:
      - service: homeassistant.turn_off
        entity_id: switch.studio_porch_lights

  # Turn on house flood lights when studio flood lights are turned on
  - alias: "House Flood Lights On"
    trigger:
      # Studio Flood Light Switch near front door
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.flood_light_studio_front
          control: 'DON'
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.flood_light_studio_front
          control: 'DFON'
      # Studio Kitchen Flood Light Button
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.flood_light_studio_back
          control: 'DON'
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.flood_light_studio_back
          control: 'DFON'
    action:
      - service: homeassistant.turn_on
        entity_id: switch.house_flood_lights

  # Turn off house flood lights when studio flood lights are turned off or house porch lights are turned fast off
  - alias: "House Flood Lights Off"
    trigger:
      # Studio Flood Light Switch near front door
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.flood_light_studio_front
          control: 'DOF'
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.flood_light_studio_front
          control: 'DFOF'
      # Studio Kitchen Flood Light Button
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.flood_light_studio_back
          control: 'DOF'
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.flood_light_studio_back
          control: 'DFOF'
    action:
      - service: homeassistant.turn_off
        entity_id: switch.house_flood_lights

  # Turn on studio flood lights when house flood lights are turned on
  - alias: "Studio Flood Lights On"
    trigger:
      # Family Room House Flood Lights Button
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.house_flood_lights_1
          control: 'DON'
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.house_flood_lights_1
          control: 'DFON'
      # Utility Room Flood Lights Button
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.house_flood_lights_2
          control: 'DON'
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.house_flood_lights_2
          control: 'DFON'
    action:
      - service: homeassistant.turn_on
        entity_id: switch.studio_flood_lights

  # Turn off studio flood light when house flood light are turned off
  - alias: "Studio Flood Lights Off"
    trigger:
      # Family Room House Flood Lights Button
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.house_flood_lights_1
          control: 'DOF'
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.house_flood_lights_1
          control: 'DFOF'
      # Utility Room Flood Lights Button
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.house_flood_lights_2
          control: 'DOF'
      - platform: event
        event_type: isy994_control
        event_data:
          entity_id: switch.house_flood_lights_2
          control: 'DFOF'
    action:
      - service: homeassistant.turn_off
        entity_id: switch.studio_flood_lights

################################################################
## Alert
################################################################
alert:
  # Front Gate open too long Alert
  front_gate_open_too_long:
    name: Front Gate is open too long!
    entity_id: binary_sensor.front_gate_open_too_long
    repeat:
      - 5
      - 10
      - 15
      - 30
      - 60
      - 1440
    notifiers:
      - ios_mike_iphone_ios
      - ios_clara_iphone_ios

  # Front Gate Reset Hardware occurred
  front_gate_reset_hardware_occurred:
    name: 'Front Gate Reset Hardware occurred!'
    entity_id: sensor.front_gate_status
    repeat: 1440
    state: 'Reset Hardware'
    notifiers:
      - ios_mike_iphone_ios

  # Front Gate Reset WiFi occurred
  front_gate_reset_wifi_occurred:
    name: 'Front Gate Reset WiFi occurred!'
    entity_id: sensor.front_gate_status
    repeat: 1440
    state: 'Reset WiFi Connect'
    notifiers:
      - ios_mike_iphone_ios

  # Front Gate Controller not on Network
  front_gate_controller_not_on_network:
    name: 'Front Gate controller is not on network!'
    entity_id: binary_sensor.front_gate_controller_not_on_network
    repeat:
      - 60
      - 120
      - 180
      - 720
      - 1440
    state: 'on'
    notifiers:
      - ios_mike_iphone_ios

  # Septic Controller Reset Hardware occurred
  septic_reset_hardware_occurred:
    name: 'Septic Reset Hardware occurred!'
    entity_id: sensor.septic_status
    repeat: 1440
    state: 'Reset Hardware'
    notifiers:
      - ios_mike_iphone_ios

  # Septic Controller Reset WiFi occurred
  septic_reset_wifi_occurred:
    name: 'Septic Reset WiFi occurred!'
    entity_id: sensor.septic_status
    repeat: 1440
    state: 'Reset WiFi Connect'
    notifiers:
      - ios_mike_iphone_ios

  # Septic Controller not on Network
  septic_controller_not_on_network:
    name: 'Septic controller is not on network!'
    entity_id: binary_sensor.septic_controller_not_on_network
    repeat:
      - 60
      - 120
      - 180
      - 720
      - 1440
    state: 'on'
    notifiers:
      - ios_mike_iphone_ios


  # Septic Controller not Idle for too long
  septic_controller_not_idle:
    name: "Septic controller is not 'Idle'"
    entity_id: binary_sensor.septic_controller_not_idle
    repeat:
      - 30
      - 60
      - 1400
    state: 'on'
    notifiers:
      - ios_mike_iphone_ios

  # Septic Controller override float
  septic_override_pump_occurred:
    name: 'Septic Override Pump On!'
    entity_id: sensor.septic_status
    state: 'Override Pump On'
    repeat: 5
    notifiers:
      - ios_mike_iphone_ios

  # Septic Controller has an Over Temperature Alarm Alert
  septic_overtemp_alarm_occurred:
    name: 'Septic Alarm: SSR Overtemp!'
    entity_id: sensor.septic_status
    state: 'Overtemp Alarm On'
    repeat: 5
    notifiers:
      - ios_mike_iphone_ios

  # Septic Controller has a Tank Overfull Alarm Alert
  septic_overfull_alarm_occurred:
    name: 'Septic Alarm: Tank Overfull!'
    entity_id: sensor.septic_status
    state: 'Tank High Alarm On'
    repeat:
      - 15
      - 30
      - 60
    notifiers:
      - ios_mike_iphone_ios

  # Septic Controller produced an Air Pump Alarm Alert
  septic_airpump_alarm_occurred:
    name: 'Septic Alarm: Air Pump Pressure Fail!'
    entity_id: sensor.septic_status
    state: 'Air Pump Alarm On'
    repeat: 5
    notifiers:
      - ios_mike_iphone_ios

  # Septic Controller produced a Bleach Level Alarm
  septic_bleach_alarm_occurred:
    name: 'Septic Alarm: Bleach Level Low!'
    entity_id: sensor.septic_status
    state: 'Bleach Alarm On'
    repeat: 5
    notifiers:
      - ios_mike_iphone_ios
