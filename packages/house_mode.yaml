################################################################
## Packages / House Mode
## House State control
################################################################

################################################################
## Customize
################################################################
homeassistant:
  customize:
    ################################################
    ## Switch
    ################################################
    # ISY-994 HA.switch "Program Switches"
    switch.house_state:                     # 'on' = Home, 'off' = Away
      friendly_name: "House Home"
      icon: mdi:home

    ################################################
    ## Binary Sensor
    ################################################
    input_boolean.guest_mode:
      friendly_name: "Guest Mode Active"
    binary_sensor.vacation_active:
      friendly_name: "Vacation Mode Active"

    ################################################
    ## Sensor
    ################################################
    sensor.house_mode:
      friendly_name: "House Mode"

################################################################
## Input Boolean
################################################################
input_boolean:
  guest_mode:
    name: "Guest Mode"
    icon: mdi:account

  vacation_mode:
    name: "Vacation Mode"
    icon: mdi:beach

################################################################
## Binary Sensor
################################################################
binary_sensor:
  - platform: template
    sensors:
      # this sensor is on when in vacation mode
      #   guest_mode must be off
      vacation_active:
        value_template: >-
          {{ is_state('input_boolean.guest_mode', 'off') and
             is_state('input_boolean.vacation_mode', 'on') }}

################################################################
## Sensor
################################################################
sensor:
  - platform: template
    sensors:
      house_mode:
        entity_id:
          - switch.house_state
          - input_boolean.guest_mode
          - binary_sensor.vacation_active
        value_template: >-
          {% if is_state('input_boolean.guest_mode', 'on') %}
            Guest
          {% elif is_state('switch.house_state', 'on') %}
            Home
          {% elif is_state('binary_sensor.vacation_active', 'on') %}
            Vacation
          {% else %}
            Away
          {% endif %}
        icon_template: >-
          {% if is_state('input_boolean.guest_mode', 'on') %}
            mdi:account
          {% elif is_state('switch.house_state', 'on') %}
            mdi:home
          {% elif is_state('binary_sensor.vacation_active', 'on') %}
            mdi:beach
          {% else %}
            mdi:home-outline
          {% endif %}

################################################################
## Automation
################################################################
automation:
  # Device Tracking switched to Somebody Home or Vacation Mode was
  #   deactivated so switch House to Home Mode
  - id: house_auto_home
    alias: House Auto Home when Somebody comes Home
    trigger:
      # Somebody home switched on
      - platform: state
        entity_id: binary_sensor.people_home
        from: 'off'
        to: 'on'
      # Switched out of Vacation Mode
      - platform: state
        entity_id: input_boolean.vacation_mode
        from: 'on'
        to: 'off'
    # Auto Away Mode does not happen in Guest Mode
    condition:
      - condition: template
        value_template: "{{ not is_state('switch.house_state', 'on') }}"
    action:
      - service: switch.turn_on
        entity_id: switch.house_state
      - service: logbook.log
        data_template:
          name: House
          message: automatically switched to Home Mode

  # Device Tracking switched to Nobody Home or Vacation Mode was activated
  #   Switch House to Away Mode if not in Guest Mode
  - id: house_auto_away
    alias: House Auto Away when Nobody is Home
    trigger:
      # Nobody home
      - platform: state
        entity_id: binary_sensor.people_away
        from: 'off'
        to: 'on'
        for: '00:10:00'
      # Switched to Vacation Mode
      - platform: state
        entity_id: input_boolean.vacation_mode
        from: 'off'
        to: 'on'
    # Auto Away Mode does not happen in Guest Mode
    condition:
      condition: state
      entity_id: input_boolean.guest_mode
      state: 'off'
    action:
      - service: switch.turn_off
        entity_id: switch.house_state
      - service: logbook.log
        data_template:
          name: House
          message: automatically switched to Away Mode

  # House manually switched to Away Mode
  #   Either by HASS switch or KeypadLinc switch
  - id: house_switched_to_away
    alias: House switched to Away
    trigger:
      platform: state
      entity_id: switch.house_state
      from: 'on'
      to: 'off'
    action:
      - service: logbook.log
        data_template:
          name: House
          message: manually switched to Away Mode
      - service: script.sonos_family_room_say
        data:
          volume: 0.5
          delay: '00:00:02'
          message: 'Goodbye.'

  # House manually switched to Home Mode
  #   Either by HASS switch or KeypadLinc switch
  - id: house_switched_to_home
    alias: House switched to Home
    trigger:
      platform: state
      entity_id: switch.house_state
      from: 'off'
      to: 'on'
    action:
      - service: logbook.log
        data_template:
          name: House
          message: manually switched to Home Mode
      - service: script.sonos_family_room_say
        data:
          volume: 0.5
          delay: '00:00:02'
          message: 'Hello.'
